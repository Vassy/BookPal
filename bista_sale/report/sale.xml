<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_saleorder_document_extended"
              inherit_id="sale.report_saleorder_document">
        <xpath expr="//t[@t-call='web.external_layout']" position="attributes">
            <attribute name="t-call">bista_report_header_footer.shipment_custom_header</attribute>
        </xpath>
        <xpath expr="//div[hasclass('page')]" position="inside">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
            <t t-set="o" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
            <div class="page">
                <div t-set="address">
                    <strong>Customer Detail:</strong>
                    <t t-if="o.partner_id.parent_id.name">
                        <div>
                            <span t-field="o.partner_id.name"/>
                            <br/>
                            <span t-field="o.partner_id.parent_id.name"/>
                        </div>
                        <div t-field="doc.partner_id"
                             t-options='{"widget": "contact", "fields": ["address", "phone"], "no_marker": True, "phone_icons": True}'/>
                    </t>
                    <t t-else="">
                        <div t-field="doc.partner_id"
                             t-options='{"widget": "contact", "fields": ["address","name","phone"], "no_marker": True, "phone_icons": True}'/>
                    </t>
                </div>
                <t t-set="report_info"
                   class="col-6 text-right mb4">
                    <h3 t-if="o.state in ['sale','order_booked','credit_review','pending_for_approval','cancel','done']">Sale Order</h3>
                    <h3 t-if="o.state in ['draft','sent','quote_approval','quote_confirm']">Quotation</h3>
                    <h3 t-if="o.state == 'cancel'">Cancelled Sale Quotation/Order</h3>
                    <h4>
                        <strong>
                            <t t-esc="o.name"/>
                        </strong>
                    </h4>
                    <t t-if="doc.state in ['draft','sent','quote_approval','quote_confirm']">
                        <strong>Quotation Date:</strong>
                        <t t-esc="o.date_order" t-options='{"widget": "date"}'/>
                        <br/>
                    </t>
                    <t t-if="doc.state in ['order_booked']">
                        <strong>Booked order date:</strong>
                        <t t-esc="o.date_order" t-options='{"widget": "date"}'/>
                        <br/>
                    </t>
                    <t t-if="doc.state  in ['sale','pending_for_approval','credit_review','cancel','done']">
                        <strong>Order Date:
                            <t t-esc="o.date_order" t-options='{"widget": "date"}'/>
                        </strong>
                    </t>
                    <br/>
                </t>
                <t t-set="information_block">
                    <div class="row">
                        <div>
                            <t t-if="doc.split_shipment">
                            </t>
                            <t t-else="">
                                <strong>Shipping Details:</strong>
                                <t t-if="o.partner_shipping_id.parent_id.name">
                                    <div>
                                        <span t-field="doc.partner_shipping_id.name"/>
                                        <br/>
                                        <span t-field="o.partner_shipping_id.parent_id.name"/>
                                    </div>
                                    <div t-field="doc.partner_shipping_id"
                                         t-options='{"widget": "contact", "fields": ["address", "phone"], "no_marker": True, "phone_icons": True}'/>
                                </t>
                                <t t-else="">
                                    <div t-field="doc.partner_shipping_id"
                                         t-options='{"widget": "contact", "fields": ["address", "name","phone"], "no_marker": True, "phone_icons": True}'/>
                                </t>
                            </t>
                        </div>
                    </div>
                </t>
                <t t-set="custom_information_block">
                    <div>
                        <t t-if="doc.state in ['draft','sent','quote_approval','quote_confirm']">
                            <strong>Quotation:</strong>
                            <t t-esc="doc.name"/>
                            <br/>
                        </t>
                        <t>
                            <strong>Need By Date:</strong>
                            <t t-esc="doc.commitment_date" t-options='{"widget": "date"}'/>
                            <br/>
                        </t>

                        <t t-if="doc.state in ['sale','order_booked','credit_review','pending_for_approval','cancel','done']">
                            <strong>Sale Order:</strong>
                            <t t-esc="doc.name"/>
                            <br/>
                        </t>
                        <t t-if="doc.state in ['draft','sent','quote_approval','quote_confirm']">
                            <strong>Quotation Date:</strong>
                            <t t-esc="o.date_order" t-options='{"widget": "date"}'/>
                            <br/>
                        </t>
                        <t t-if="doc.state in ['sale','order_booked','credit_review','pending_for_approval','cancel','done']">
                            <strong>Order Date:</strong>
                            <span t-esc="o.date_order" t-options='{"widget": "date"}'>
                            </span>
                            <br/>
                        </t>
                        <strong>Customer Ref:</strong>
                        <t t-esc="doc.client_order_ref"/>
                        <br/>
                        <t t-if="doc.state not in ['sale','order_booked','credit_review','pending_for_approval','cancel','done']">
                        <strong>Valid Until:</strong>
                        <t t-esc="doc.validity_date" t-options='{"widget": "date"}'/>
                        <br/>
                        </t>
                        <strong>Salesperson:</strong>
                        <t t-esc="o.user_id.name"/>
                        <br/>
                    </div>
                </t>
            </div>
        </xpath>
        <xpath expr="//p[@t-field='doc.note']" position="replace">
            <div style="margin-top:40px;">
                <strong style="border-bottom:solid 1px;">Order Terms and Conditions</strong>
                <p class="mb-1" t-field="doc.note" style="margin-left: 50px;"/>
                <!--                  <span t-field="doc.note"/>-->
            </div>
        </xpath>
        <xpath expr="//table[hasclass('table','table-sm','o_main_table')]" position="before">
            <span style="font-size:20px;">
                <strong>Product Details</strong>
            </span>
            <t t-set="line_taxes" t-value="any(line.tax_id for line in doc.order_line)"/>
        </xpath>
        <xpath expr="//thead" position="replace">
            <thead>
                <tr style="border-top: 1px solid black;">
                    <th style="border: none;" name="th_sn" class="text-center">
                        <strong>SN</strong>
                    </th>
                    <th colspan="2" style=" border-collapse: collapse;
                   border: none;" name="image" class="text-center">Description
                    </th>
                    <th style=" border-collapse: collapse;
                   border: none;" name="th_quantity" class="text-center">Format
                    </th>
                    <th style=" border-collapse: collapse;
                   border: none;" name="th_quantity" class="text-center">Quantity
                    </th>
                    <th style=" border-collapse: collapse;
                   border: none;" name="th_uom" class="text-center">Cover
                    </th>
                    <th style=" border-collapse: collapse;
                   border: none;" name="th_priceunit" class="text-center">Price
                    </th>
                    <th name="th_taxes" t-if="line_taxes" class="text-center"
                        style=" border-collapse: collapse;border: none; display:none !important;">
                        <span>Taxes</span>
                    </th>
                    <th style=" border-collapse: collapse;
                   border: none;padding-left:15px;" name="th_subtotal" class="text-right">
                        <span groups="account.group_show_line_subtotals_tax_excluded">
                            Total
                        </span>
                        <span groups="account.group_show_line_subtotals_tax_included">
                            Total Price
                        </span>
                    </th>
                </tr>
            </thead>

        </xpath>
        <xpath expr="//t[@t-foreach='doc.order_line']" position="before">
            <t t-set="sn" t-value="1"/>
        </xpath>

        <xpath expr="//t[@t-if='not line.display_type']" position="replace">
            <t t-if="not line.display_type">
                <td style="border-top: 1px solid black; border-left: none;
                border-right: none; border-bottom: 1px solid black;" name="td_sn" class="text-center">
                    <span t-esc="sn"/>
                    <br/>
                    <t t-set="sn" t-value="sn+1"/>
                </td>
                <td style="border-top: 1px solid black; border-left: none;
                border-right: none; border-bottom: 1px solid black;" name="image" class="text-center">
                    <t t-if="line.product_id.image_1920">
                        <img t-attf-src="data:image/*;base64,{{line.product_id.image_1920}}"
                             style="max-height:100px; max-width:100px;"/>
                    </t>
                    <t t-else="">
                        <img src="/web/static/img/placeholder.png" style="max-height:100px; max-width:100px;"/>
                    </t>
                </td>
                <td name="td_name" style="width:20%; border-top: 1px solid black; border-left: none;
                border-right: none; border-bottom: 1px solid black;">
                    <b>
                        <span t-field="line.name"/>
                    </b>
                    <br/>
                    <span t-field="line.product_id.default_code"/>
                    <!-- <br/> -->
                    <!-- <span>Format:</span> -->
                    <!--                        <span t-field="line.product_id.format"/>-->
                </td>
                <td name="td_format" style="border-top: 1px solid black; border-left: none;
                 border-right: none;border-bottom: 1px solid black;" class="text-center">
                    <span t-field="line.product_id.product_format"/>
                </td>
                <td style="border-top: 1px solid black; border-left: none;
                 border-right: none;border-bottom: 1px solid black;" name="td_quantity" class="text-center">
                    <span t-if="float(line.product_uom_qty).is_integer()"
                          t-esc="int(line.product_uom_qty)"/>
                    <span t-if="not float(line.product_uom_qty).is_integer()"
                          t-field="line.product_uom_qty"/>
                </td>
                <td style="border-top: 1px solid black; border-left: none;
                            border-right: none; border-bottom: 1px solid black;"
                    name="td_uom" class="text-right">
                    <t t-if="line.discount">
                        <s>
                            <span t-field="line.price_unit"
                                  t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                        </s>
                    </t>
                    <t t-else="">
                        <span t-field="line.price_unit"
                              t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                    </t>
                </td>
                <td style="border-top: 1px solid black; border-left: none;
                     border-right: none; border-bottom: 1px solid black;" name="td_priceunit" class="text-right">
                    <span>
                        <t t-if="line.discount">
                            <t t-esc="line.price_unit-((line.discount/100)*line.price_unit)"
                               t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                        </t>
                        <t t-else="">
                            <span t-field="line.discounted_price"
                                  t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                        </t>
                    </span>
                </td>
                <td t-if="line_taxes" name="td_taxes" class="text-center" style="border-top: 1px solid black; border-left: none;
                     border-right: none; border-bottom: 1px solid black;display:none !important;">
                    <span t-esc="', '.join(map(lambda x: (x.name), line.tax_id))"/>
                </td>
                <td style="border-top: 1px solid black; border-left: none;
                border-right: none; border-bottom: 1px solid black;"
                    name="td_subtotal" class="text-right">
                    <t t-if="line.price_subtotal">
                        <span t-field="line.price_subtotal"
                              groups="account.group_show_line_subtotals_tax_excluded"/>
                        <span t-field="line.price_total"
                              groups="account.group_show_line_subtotals_tax_included"/>
                    </t>
                    <t t-else="">
                        <span style="padding-left:22px;" t-field="line.price_subtotal"/>
                    </t>
                </td>
            </t>
        </xpath>
        <xpath expr="//table[hasclass('table', 'table-sm', 'o_main_table')]"
               position="attributes">
            <attribute name="style">margin-top: 10px; border:none;</attribute>
        </xpath>
        <!-- Hidden payment terms from base  -->
        <xpath expr="//p[@t-if='not is_html_empty(doc.payment_term_id.note)']"
               position="replace">
        </xpath>
        <!-- Added "Customer Details" label in report  -->
        <xpath expr="//div[@t-field='doc.partner_id']" position="before">
            <strong>Customer Details</strong>
        </xpath>
        <!-- Hidden information block from base report  -->
        <xpath expr="//div[hasclass('page')]/div[@id='informations']" position="replace"/>
        <!-- Hidden Quotation & Order # from base report  -->
        <xpath expr="//div[hasclass('page')]/h2" position="replace">
        </xpath>
        <!-- added total saving  beside total summery table  -->
        <xpath expr="//div[@name='so_total_summary']" position="replace">
            <div class="clearfix row" name="so_total_summary">
                <div class="col-6">
                    <span style="color:black;">
                        <b>Total Savings:
                        </b>
                        <span t-esc="sum((line.product_uom_qty*line.price_unit)-line.price_subtotal for line in doc.order_line)"
                              t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                    </span>
                </div>
                <div>
                    <table style="width:170pt;margin-left:190px; border-left: 1px solid black; border-right: 1px solid black;">
                        <tr style="border-top: 1px solid black;">
                            <td style="height:1px; color: black; padding-left:10px;"
                                class="text-left">
                                <strong>Subtotal</strong>
                            </td>

                            <td style="padding-right:8px;height:1px;padding-left:10px; border-left: 1px solid black;background-color: white; color:black;"
                                class="text-right">
                                <span t-field="doc.amount_untaxed"/>
                            </td>
                        </tr>
                        <tr style="border-top: 1px solid black;">
                            <td style="height:1.5px;background-color: white; padding-left:10px;"
                                class="text-left">
                                <strong class="text-right">Tax</strong>
                            </td>
                            <td style="padding-right:8px; height:1.5px;border-left: 1px solid black; color:black; background-color: white;"
                                class="text-right">
                                <span t-field="doc.amount_tax"/>
                            </td>
                        </tr>
                        <tr style="border-top: 1px solid black;">
                            <td style="padding-top:5px;color: black; padding-left:10px; background-color: white;"
                                class="text-left">
                                <t t-if="doc.carrier_id">
                                    <strong class="text-left">Shipping</strong>
                                    <br/>

                                    (<span style="font-size:14px; color: black;" t-field="doc.carrier_id"/>)
                                </t>
                                <t t-else="">
                                    <strong class="text-left">Shipping</strong>
                                </t>

                            </td>
                            <td style="height:1px;padding-right:8px;padding-top:5px;border-left: 1px solid black; padding-left:10px; background-color: white;"
                                class="text-right">
                                <t t-esc="sum([line.price_total for line in doc.order_line if line.is_delivery])"
                                   t-options='{"widget": "monetary", "display_currency": doc.currency_id}'>
                                </t>
                            </td>
                        </tr>
                        <tr style="background-color: #f56343; border-top: 1px solid black;">
                            <td style="padding-left:10px;color: black;" class="text-left">
                                <strong class="border-black o_subtotal;text-right">Total</strong>
                            </td>
                            <td style="padding-right:8px;color: black;border-left: 1px solid black;" class="text-right">
                                <strong t-field="doc.amount_total"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </xpath>
    </template>
</odoo>